{% extends 'base.html.twig' %}

{% block pageHeader %}
    <div class="page-header">
        <div class="container">
            <h2 class="color3">{{ discipline.nom }}</h2>
            <ul class="breadcrumb">
                <li class="color3">Documents</li>
            </ul>
        </div>
    </div>
{% endblock %}

{% block main %}
    <script src="{{ asset('vendors/jquery-ui/jquery-ui.min.js') }}" type=text/javascript></script>
    <script src="{{ asset('educomp/ckeditor/ckeditor.js') }}"></script>
    <script src="{{ asset('educomp/ckeditor/adapters/jquery.js') }}"></script>
    <script>
        jQuery(document).ready(function () {

            var config = {
                configname:"lightConfig",
                toolbar:
                        [
                            { name: 'basicstyles', items : [ 'Bold','Italic','Underline','Strike','Subscript','Superscript' ] },
                            { name: 'paragraph',   items : [ 'NumberedList','BulletedList','-','JustifyLeft','JustifyCenter','JustifyRight','JustifyBlock'] },
                            '/',
                            { name: 'styles',      items : [ 'Font','FontSize' ] },
                            { name: 'colors',      items : [ 'TextColor','BGColor' ] },
                            { name: 'switch',      items : [ 'Switch' ] }
                        ],
                height: 100,
                allowedContent: true
            };
            $('textarea.simpleEditor').ckeditor(config);

            $('.openPopupUpload').click(function() {
                $('[data-champname="nom"]').removeClass('champError').val('');
                $('.contentDocInfos').show();
                $('.contentDocRess').hide();
                $('.selectpicker').selectpicker('val', 'tous');

                var idDisc = $(this).closest('[data-discId]').attr('data-discId');

                $('.modal').modal();
                $('.modal .modal-body').hide();
                var popup = $('.modal .modal-body[data-contentModal=appendDoc]');
                popup.show();

                var folderLocation = 'var/upload/';
                var url = '../'+folderLocation+'docs/disc/'+idDisc+'/';

                $.ajax({
                    type: 'POST',
                    url: "{{path('checkDirForUploadFile_ajax')}}",
                    async: false,
                    dataType: "json",
                    data: {
                        url: url
                    },
                    success: function (data) {
                    },
                    error: function(xhr, status, error) {
                    }
                });

                $('#docUpload').fileupload({
                    url: '../../../'+folderLocation,
                    dropZone:null,
                    dataType: 'json',
                    done: function (e, data) {
                        console.log('test')
                        $.each(data.result.files, function (index, file) {
                            var myUrlTab = file.url.split(folderLocation);
                            $.ajax({
                                type: 'POST',
                                url: "{{path('uploadDocFile_ajax')}}",
                                async: false,
                                dataType: "json",
                                data: {
                                    discId: idDisc,
                                    userId: $('[data-userId]').attr('data-userId'),
                                    url: '../'+folderLocation+myUrlTab[1],
                                    urlDest: url,
                                    currentUrl: window.location.pathname,
                                    nom: $('[data-champname="nom"]').val(),
                                    description: CKEDITOR.instances[$('[data-champName=description]').attr('id')].getData()
                                },
                                success: function (data) {
                                    $('.modal').modal('toggle');
                                    //window.location.href = window.location.href;
                                },
                                error: function(xhr, status, error) {
                                    $('.modal').modal('toggle');
                                }
                            });
                        });

                    },
                    progressall: function (e, data) {
                        var progress = parseInt(data.loaded / data.total * 100, 10);
                        $('#itemProgress').find('.progress-bar').css(
                                'width',
                                progress + '%'
                        );
                    }
                }).prop('disabled', !$.support.fileInput).parent().addClass($.support.fileInput ? undefined : 'disabled');
            });
            $('.nextStepPopup').click(function(){
                if($('[data-champname="nom"]').val() != ""){
                    $('.contentDocInfos').hide();
                    $('.contentDocRess').show();
                }else{
                    $('[data-champname="nom"]').addClass('champError');
                }
            });
            $('[data-champname="nom"]').on('input', function(){
                $('[data-champname="nom"]').removeClass('champError');
            });
        });
    </script>

    <div class="bgcolor3 pt-100 pb-100" data-discId="{{ discipline.id }}">
        <div class="container">
            <a class="openPopupUpload btn btn-primary btn-sm">Ajouter un document</a>
            <div class="row">
                <div class="col-sm-12">
                    <table class="table table-boxed">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Fichier</th>
                                <th>Auteur</th>
                                <th>Date de dépôt</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key,val in documents %}
                                <tr>
                                    <th scope="row">{{ key+1 }}</th>
                                    <td><a href="{{ val.fromDisc.url }}">{{ val.fromDisc.nom }}</a></td>
                                    <td>{{ val.fromDisc.proprietaire.firstname }} {{ val.fromDisc.proprietaire.lastName }}</td>
                                    <td>{{ val.fromDisc.dateCrea|localizeddate('none', 'none', null, null, 'd LLLL Y à h:mm' ) }}</td>
                                    <td><a href="{{ val.fromDisc.url }}" class="btn btn-primary btn-sm">Télécharger</a></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>

                <!--                  POPUP Ajout Document                     -->

                <div class="modal-body" data-contentModal="appendDoc" data-idItem="" style="background:#aaa; background-size:cover">
                    <div class="row">
                        <div class="bginverse">
                            <div class="">
                                <div class="contentDocInfos">
                                    <div class="row mb-10">
                                        <div class="LabelAdmin col-sm-3">Nom</div>
                                        <input data-champName="nom" class="champAdmin col-sm-9 col-xs-12" value=""/>
                                    </div>
                                    <div class="row mb-10">
                                        <div class="LabelAdmin col-sm-3">Description</div>
                                        <div class="noPadding col-sm-9  col-xs-12">
                                            <textarea data-champName="description" id="descriptionNewDoc" class="simpleEditor editor champAdmin"></textarea>
                                        </div>
                                    </div>
                                    <div class="row mb-10">
                                        <div class="LabelAdmin col-sm-3">Destinataires</div>
                                        <select class="selectpicker col-xs-9" data-style="MyBtnSelectPickeer" multiple>
                                            <option title="Tous les inscrits" value="tous">Tous</option>
                                            <option data-divider="true"></option>
                                            {% for key,val in users %}
                                                <option title="{{ val.firstname }} {{ val.lastname }}" class="addDocDest" val="{{ val.id }}">{{ val.firstname }} {{ val.lastname }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="row mb-10" style="text-align: center">
                                        <div class="btn btn-sm btn-info mb-3 nextStepPopup">Suivant</div>
                                    </div>
                                </div>
                                <div class="contentDocRess">

                                    <div class="labelDoc col-sm-6 col-xs-12">
                                        Fichier du document :
                                    </div>

                                    <div class="fileUploader col-sm-6 col-xs-12">
                                        <span class="btn btn-success fileinput-button">
                                            <i class="glyphicon glyphicon-plus"></i>
                                            <span>Déposer mon fichier</span>
                                            <input id="docUpload" type="file" name="files[]" multiple>
                                        </span>

                                        <div id="itemProgress" class="progress col-xs-12">
                                            <div class="progress-bar progress-bar-success"></div>
                                        </div>
                                    </div>
                                </div>


                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}