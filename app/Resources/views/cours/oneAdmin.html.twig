{% extends 'base.html.twig' %}

{% block title %}
    <title>
        {{ cours.discipline.nom }}
    </title>
{% endblock %}

{% block titrePage %}Bienvenue sur la plateforme de l'AFADEC{% endblock %}
{% block sousTitrePage %}Association pour la Formation A Distance de l'Enseignement Catholique{% endblock %}

{% block vueAdmin %}
    {% if app.user.hasRole('ROLE_SUPER_ADMIN') or ((app.user.statut == 'Responsable' or app.user.statut == 'Formateur') and app.user.confirmedByAdmin) %}
        <li><a href="{{ path('oneCours', {id: cours.id, mode: 'etu'}) }}">Vue étudiant</a></li>
        <li><a href="{{ path('oneCours', {id: cours.id, mode: 'ens'}) }}">Vue enseignant correcteur</a></li>
    {% endif %}
{% endblock %}

{% block pageHeader %}
    {% include "cours/filAriane.html.twig" %}
{% endblock %}

{% block main %}
    <script src="{{ asset('vendors/jquery-ui/jquery-ui.min.js') }}" type=text/javascript></script>
    <script src="{{ asset('vendors/ckeditor/ckeditor.js') }}"></script>
    <script src="{{ asset('vendors/ckeditor/adapters/jquery.js') }}"></script>

    <script type="text/javascript" src="{{ asset('vendors/moment/min/moment.min.js') }}"></script>
    <script type="text/javascript" src="{{ asset('vendors/moment/min/moment-with-locales.min.js') }}"></script>
    <script type="text/javascript"
            src="{{ asset('vendors/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js') }}"></script>
    <link rel="stylesheet"
          href="{{ asset('vendors/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css') }}"/>

    <style>
        .btnValidateSharedDocsIntitule {
            height: 27px;
            line-height: 27px;
        }

        .btnDesactivated {
            background: #aaa !important;
            cursor: default;
        }

        .btnDesactivated:hover {
            color: #fff !important;
        }

        .unvalidated {
            color: red;
        }
    </style>

    <script>
        jQuery(document).ready(function () {
            let steps = $('[data-uploadSteps]').attr('data-uploadSteps');
            let upload_srcSteps = $('[data-uploadSrcSteps]').attr('data-uploadSrcSteps');
            let folderLocation = $('[data-folderUpload]').attr('data-folderUpload');
            let upload_course = $('[data-courseUpload]').attr('data-courseUpload');

            CKEDITOR.config.entities = false;
            CKEDITOR.config.entities_latin = false;

            let config = {
                configname: "lightConfig",
                toolbar:
                    [
                        {
                            name: 'basicstyles',
                            items: ['Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript']
                        },
                        {
                            name: 'paragraph',
                            items: ['NumberedList', 'BulletedList', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock']
                        },
                        '/',
                        {name: 'styles', items: ['Font', 'FontSize']},
                        {name: 'colors', items: ['TextColor', 'BGColor']},
                        {name: 'switch', items: ['Switch']}
                    ],
                height: 100,
                allowedContent: true
            };
            let config2 = {
                configname: "hugeConfig",
                toolbar:
                    [
                        {name: 'document', items: ['Preview', '-', 'Templates']},
                        {
                            name: 'clipboard',
                            items: ['Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo']
                        },
                        {name: 'editing', items: ['Find', 'Replace', '-', 'SelectAll', '-', 'SpellChecker']},
                        '/',
                        {
                            name: 'basicstyles',
                            items: ['Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', '-', 'RemoveFormat']
                        },
                        {
                            name: 'paragraph',
                            items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'Blockquote', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock']
                        },
                        {name: 'links', items: ['Link', 'Unlink']},
                        {name: 'insert', items: ['Image', 'Flash', 'Table', 'HorizontalRule', 'Smiley', 'SpecialChar']},
                        '/',
                        {name: 'styles', items: ['Format', 'Font', 'FontSize']},
                        {name: 'colors', items: ['TextColor', 'BGColor']},
                        {name: 'tools', items: ['Maximize', 'ShowBlocks']},
                        {name: 'switch', items: ['Switch']}
                    ],
                height: 200,
                allowedContent: true
            };

            let uncheckedClass = 'fa-square-o';
            let checkedClass = 'fa-check-square-o';

            // les ckeditors ne sont pas chargés à l'init, sinon la page est bcp trop lourde à charger
            $('.simpleEditor[readonly]').click(function () {
                activateCK($(this), config);
            });
            $('.complexEditor[readonly]').click(function () {
                activateCK($(this), config2);
            });
            $('.simpleEditor.toActivate').each(function () {
                activateCK($(this), config);
            });

            function activateCK(editor, config) {
                editor.attr("readonly", false);
                editor.ckeditor(config);
                for (let i in CKEDITOR.instances) {
                    CKEDITOR.instances[i].on('change', function () {
                        let idItem = $(this).attr('name');
                        let elem = $('#' + idItem).closest('.courseElemAdmin');
                        detectInput(elem);
                    });
                }
            }

            // click sur le check : affichage ou non de la zoneRessource
            $('.activationBtn').click(function () {
                let elem = $(this).closest('.courseElemAdmin');
                let id = elem.attr('data-idzone');
                let isVisible = $(this).hasClass(checkedClass);
                let myBtn = $(this);
                $.ajax({
                    type: "POST",
                    url: "{{ path('activateZone_ajax') }}",
                    data: {
                        id: id,
                        isVisible: isVisible
                    },
                    dataType: "json",
                    success: function (response) {
                        updateCheckedState(myBtn, response["isVisible"]);
                        elem.attr('data-isVisible', response["isVisible"])
                    }
                });
            });

            // click sur la suppression de la zoneRessource
            $('.btnDeleteElem').click(function () {
                let id = $(this).closest('.courseElemAdmin').attr('data-idzone');
                let myBtn = $(this);
                $.ajax({
                    type: "POST",
                    url: "{{ path('deleteZone_ajax') }}",
                    data: {
                        id: id
                    },
                    dataType: "json",
                    success: function () {
                        myBtn.closest('.courseElemAdmin').remove();
                    }
                });
            });

            // déplacement des zones
            $('.btnMoveDown').click(function () {
                let elem = $(this).closest('.courseElemAdmin');
                let next = elem.next('.courseElemAdmin');
                elem.insertAfter(next);
                reorderZone($(this).closest('.courseElems'))
            });
            $('.btnMoveUp').click(function () {
                let elem = $(this).closest('.courseElemAdmin');
                let prev = elem.prev('.courseElemAdmin');
                elem.insertBefore(prev);
                reorderZone($(this).closest('.courseElems'))
            });
            $('.btnMoveTotalDown').click(function () {
                let elem = $(this).closest('.courseElemAdmin');
                elem.appendTo(elem.closest('.courseElems'));
                reorderZone($(this).closest('.courseElems'))
            });
            $('.btnMoveTotalUp').click(function () {
                let elem = $(this).closest('.courseElemAdmin');
                elem.prependTo(elem.parent());
                reorderZone($(this).closest('.courseElems'))
            });

            function reorderZone(zoneList) {
                let arrayZones = [];
                zoneList.find('[data-idzone]').each(function () {
                    arrayZones.push($(this).attr('data-idzone'));
                });

                $.ajax({
                    type: "POST",
                    url: "{{ path('sortZone_ajax') }}",
                    data: {
                        arrayZones: arrayZones
                    },
                    dataType: "json",
                    success: function (response) {
                        if (!response["error"]) {

                        } else {
                            console.log("Erreur de tri des zones");
                        }
                    }
                });
            }

            /*
             AJOUTS DE ZONES
             */
            //Ajout d'une ressource existante
            $('.addExistingRessource').click(function () {
                $('.modal').modal();
                $('.modal .modal-body').hide();
                $('.modal .modal-body[data-contentModal=ajoutRessExist]').attr('data-idSection', $(this).closest('.section').attr('data-idSection')).show();
            });


            // Ajout de nouvelles ressources
            $('.addNewItem').click(function () {
                let idItem = 0;
                let idSection = $(this).closest('.section').attr('data-idSection');

                let typeItem;
                if ($(this).hasClass('addNewTypeDevoir')) {
                    typeItem = "devoir";
                } else if ($(this).hasClass('addNewTypeLien')) {
                    typeItem = "lien";
                } else if ($(this).hasClass('addNewTypeLibre')) {
                    typeItem = "libre";
                } else if ($(this).hasClass('addNewTypeGroupe')) {
                    typeItem = "groupe";
                } else if ($(this).hasClass('addNewTypeForum')) {
                    typeItem = "forum";
                } else if ($(this).hasClass('addNewTypeChat')) {
                    typeItem = "chat";
                } else if ($(this).hasClass('addNewTypePodcast')) {
                    typeItem = "podcast";
                }

                $.ajax({
                    type: "POST",
                    url: "{{ path('addZone_ajax') }}",
                    data: {
                        idItem: idItem,
                        idSection: idSection,
                        typeItem: typeItem,
                        idCours: $('[data-coursId]').attr('data-coursId')
                    },
                    dataType: "json",
                    success: function (response) {
                        if (!response["error"]) {
                            window.location.href = window.location.href.replace(/[\?#].*|$/, "?idSection=" + idSection);
                        } else {
                            console.log("Erreur d'ajout de l'item " + idItem + " à la section");
                        }
                    }
                });
            });

            // click sur le check : affichage ou non de la section
            $('.activationSectionBtn').click(function () {
                let id = $(this).closest('.adminSectionRow').attr('data-idsection');
                let isVisible = $(this).hasClass(checkedClass);
                let myBtn = $(this);
                $.ajax({
                    type: "POST",
                    url: "{{ path('activateSection_ajax') }}",
                    data: {
                        id: id,
                        isVisible: isVisible
                    },
                    dataType: "json",
                    success: function (response) {
                        updateCheckedState(myBtn, response["isVisible"]);
                        myBtn.closest('.adminSectionRow').removeClass('visibility_');
                        $('.ongletSection[data-idsection=' + id + ']').removeClass('visibility_');
                        if (!response["isVisible"]) {
                            myBtn.closest('.adminSectionRow').addClass('visibility_');
                            $('.ongletSection[data-idsection=' + id + ']').addClass('visibility_');
                        }
                    }
                });
            });

            // modification du nom d'une section
            $('.nomSectionInput').on('input', function () {
                if (!$(this).hasClass('inEdition')) {
                    let sectionInput = $(this);
                    sectionInput.addClass('inEdition');
                    sectionInput.after('<div class="myBtn btnSaveInputChange btnAdmin btnMiddle col-sm-1 col-xs-1"><i class="fa fa-floppy-o"></i></div>')
                    sectionInput.next('.btnSaveInputChange').click(function () {
                        let id = sectionInput.closest('.adminSectionRow').attr('data-idsection');
                        let nom = sectionInput.val();
                        $.ajax({
                            type: 'POST',
                            url: "{{ path('changeNameSection_ajax') }}",
                            async: false,
                            dataType: "json",
                            data: {
                                id: id,
                                nom: nom
                            },
                            success: function () {
                                sectionInput.removeClass('inEdition');
                                sectionInput.next('.btnSaveInputChange').remove();
                                $('.ongletSection[data-idsection=' + id + '] .nomSection').text(nom);
                            }
                        });
                    });
                }
            });
            $('.faIconSectionInput').on('input', function () {
                if (!$(this).hasClass('inEdition')) {
                    let sectionInput = $(this);
                    sectionInput.addClass('inEdition');
                    sectionInput.after('<div class="myBtn btnSaveInputChange btnAdmin btnMiddle col-sm-1 col-xs-1"><i class="fa fa-floppy-o"></i></div>')
                    sectionInput.next('.btnSaveInputChange').click(function () {
                        let id = sectionInput.closest('.adminSectionRow').attr('data-idsection');
                        let faIcon = sectionInput.val();
                        $.ajax({
                            type: 'POST',
                            url: "{{ path('changefaIconSection_ajax') }}",
                            async: false,
                            dataType: "json",
                            data: {
                                id: id,
                                faIcon: faIcon
                            },
                            success: function () {
                                window.location.href = window.location.href.replace(/[\?#].*|$/, "?sectionAdmin");
                            }
                        });
                    });
                }
            });

            //Ajout d'une section
            $('.nomSectionAddInput').on('input', function () {
                let sectionInput = $(this);
                if (!$(this).next('.btnAddSection').hasClass('actif') && $(this).val() !== "") {
                    sectionInput.addClass('inEdition');
                    sectionInput.next('.btnAddSection').addClass('actif').click(function () {
                        $.ajax({
                            type: 'POST',
                            url: "{{ path('addSection_ajax') }}",
                            async: false,
                            dataType: "json",
                            data: {
                                coursId: $('[data-coursId]').attr('data-coursId'),
                                nom: sectionInput.val()
                            },
                            success: function (data) {
                                window.location.href = window.location.href.replace(/[\?#].*|$/, "?sectionAdmin");
                            }
                        });
                    });
                } else if ($(this).val() === "") {
                    sectionInput.removeClass('inEdition');
                    $('.btnAddSection').removeClass('actif').unbind('click');
                }
            });

            // click sur la suppression de la section
            $('.btnDeleteSection').click(function () {
                let id = $(this).closest('.adminSectionRow').attr('data-idsection');
                $.ajax({
                    type: "POST",
                    url: "{{ path('deleteSection_ajax') }}",
                    data: {
                        id: id
                    },
                    dataType: "json",
                    success: function (response) {
                        if (!response["error"]) {
                            window.location.href = window.location.href.replace(/[\?#].*|$/, "?sectionAdmin");
                        } else {
                            let chaine = "la zone contenue";
                            if (response["nbZone"] > 1) {
                                chaine = "les " + response["nbZone"] + " zones contenues";
                            }
                            alert("Vous devez préalablement supprimer " + chaine + " dans cette section");
                        }
                    }
                });
            });

            // activation du sortable des sections
            $('.sortableSections').sortable({
                placeholder: "ui-state-highlight",
                handle: ".btnMove",
                cancel: ".notSortable",
                stop: function (event, ui) {
                    let arraySections = [];
                    let itemDropped = ui.item;
                    let id = itemDropped.attr('data-idsection');
                    $(this).find('[data-idsection]').each(function () {
                        arraySections.push($(this).attr('data-idsection'));
                    });

                    $.ajax({
                        type: "POST",
                        url: "{{ path('sortSection_ajax') }}",
                        data: {
                            arraySections: arraySections
                        },
                        dataType: "json",
                        success: function (response) {
                            if (!response["error"]) {
                                //on remet aussi à la bonne place l'onglet de gauche correspondant
                                let onglet = $('.ongletSection[data-idsection=' + id + ']');
                                let newOngleIndex = itemDropped.index();

                                let nbAdminIndex = $('.ongletAdmin').length;

                                onglet.insertAfter($('.ongletSection:eq(' + parseInt(newOngleIndex - 2 + nbAdminIndex) + ')'));
                            } else {
                                console.log("Erreur de tri des sections");
                            }
                        }
                    });
                }
            });

            function refreshInSection(idSection) {
                window.location.href = window.location.href.replace(/[\?#].*|$/, "?idSection=" + idSection);
            }

            // ajout d'un item du cours dans une section (via la modale)
            $('.btnAddItem').click(function () {
                let idItem = $(this).closest('.item').attr('data-idItem');
                let typeItem = $(this).closest('.item').attr('data-typeItem');
                let idSection = $(this).closest('.modal-body').attr('data-idSection');
                $.ajax({
                    type: "POST",
                    url: "{{ path('addZone_ajax') }}",
                    data: {
                        idItem: idItem,
                        idSection: idSection,
                        typeItem: typeItem
                    },
                    dataType: "json",
                    success: function (response) {
                        if (!response["error"]) {
                            refreshInSection(idSection);
                        } else {
                            console.log("Erreur d'ajout de l'item " + idItem + " à la section");
                        }
                    }
                });
            });

            // GESTION DES RESSOURCES
            // suppression d'un item
            $('.btnSupprElem:not(.btnDeleteSection)').click(function () {
                let idItem = $(this).closest('.courseElemAdmin').attr('data-idItem');
                let typeItem = $(this).closest('.courseElemAdmin').attr('data-typeItem');
                let idSection = null;

                if ($(this).closest('[data-idSection]')) {
                    idSection = $(this).closest('[data-idSection]').attr('data-idSection');
                }

                $('.modal').modal();
                $('.modal .modal-body').hide();
                $('.modal .modal-body[data-contentModal=alertDeleteZoneRess]').show();

                $.ajax({
                    type: "POST",
                    url: "{{ path('getNbZoneRess_ajax') }}",
                    data: {
                        idItem: idItem
                    },
                    dataType: "json",
                    success: function (data) {

                        $('.nbZoneUseOfRess').text(data['nb']);

                        $('.validateRessDeletion').unbind('click').click(function () {
                            $.ajax({
                                type: "POST",
                                url: "{{ path('supprItem_ajax') }}",
                                data: {
                                    idItem: idItem,
                                    typeItem: typeItem
                                },
                                dataType: "json",
                                success: function (response) {
                                    if (!response["error"]) {
                                        if (idSection == null) {
                                            window.location.href = window.location.href.replace(/[\?#].*|$/, "?ressourcesAdmin");
                                        } else {
                                            refreshInSection(idSection);
                                        }
                                    } else {
                                        console.log("Erreur de suppression de l'item " + idItem);
                                    }
                                }
                            });
                        });


                    }
                });


            });
            // modification d'un champ d'une ressource
            $('.champAdmin').on('input', function () {
                let elem = $(this).closest('.courseElemAdmin');
                detectInput(elem);
            });
            $('[data-champName=typeLien]').on('change', function () {
                let elem = $(this).closest('.courseElemAdmin');
                detectInput(elem);
                // mise à jour de l'icone (prévisualisation) ) chaque changement d'option
                elem.find('.detailIconTypeLien i').remove();
                elem.find('.detailIconTypeLien').append('<i class="fa ' + $(this).find("option:selected").attr('data-icon') + '"></i>');
            });
            $('.addNewResponsable').click(function () {
                let elem = $(this).closest('.courseElemAdmin');
                detectInput(elem);
            });
            $('[data-champName=enabled]').click(function () {
                let elem = $(this).closest('.courseElemAdmin');
                detectInput(elem);
            });

            function detectInput(elem) {
                if (!elem.hasClass('inEdition')) {
                    elem.addClass('inEdition');
                    if (elem.find('.btnActionCol .btnDelete').length) {
                        elem.find('.btnActionCol .btnDelete:first').before('<div class="myBtn btnSaveInputChange btnAdmin btnLeft"><i class="fa fa-floppy-o"></i></div>');
                    } else {
                        elem.find('.btnActionCol').append('<div class="myBtn btnSaveInputChange btnAdmin btnLeft"><i class="fa fa-floppy-o"></i></div>');
                    }
                    if (elem.attr('data-typeItem') === 'lien') {
                        changeLien(elem);
                    } else if (elem.attr('data-typeItem') === 'groupe') {
                        changeGroupe(elem);
                    } else if (elem.attr('data-typeItem') === 'libre') {
                        changeLibre(elem);
                    } else if (elem.attr('data-typeItem') === 'devoir') {
                        changeDevoir(elem);
                    } else if (elem.attr('data-typeItem') === 'forum') {
                        changeForum(elem);
                    } else if (elem.attr('data-typeItem') === 'chat') {
                        changeChat(elem);
                    } else if (elem.attr('data-typeItem') === 'podcast') {
                        changePodcast(elem);
                    }
                }
            }

            function changeLien(lien) {
                lien.find('.btnSaveInputChange').click(function () {
                    let idSection = $(this).closest('[data-idSection]').attr('data-idSection');
                    let id = lien.attr('data-idItem');
                    let nom = lien.find('[data-champName=nom]').val();
                    let url = lien.find('[data-champName=url]').val();
                    let description = lien.find('textarea[data-champName=description]').val();
                    if (CKEDITOR.instances[lien.find('[data-champName=description]').attr('id')]) {
                        description = CKEDITOR.instances[lien.find('[data-champName=description]').attr('id')].getData();
                    }
                    let typeLien = lien.find('[data-champName=typeLien]').val();

                    $.ajax({
                        type: 'POST',
                        url: "{{ path('changeContentLien_ajax') }}",
                        async: false,
                        dataType: "json",
                        data: {
                            id: id,
                            nom: nom,
                            url: url,
                            description: description,
                            typeLien: typeLien
                        },
                        success: function () {
                            refreshInSection(idSection);
                        }
                    });
                });
            }

            function changeChat(chat) {
                chat.find('.btnSaveInputChange').click(function () {
                    let idSection = $(this).closest('[data-idSection]').attr('data-idSection');
                    let id = chat.attr('data-idItem');
                    let nom = chat.find('[data-champName=nom]').val();
                    let description = chat.find('textarea[data-champName=description]').val();
                    if (CKEDITOR.instances[chat.find('[data-champName=description]').attr('id')]) {
                        description = CKEDITOR.instances[chat.find('[data-champName=description]').attr('id')].getData();
                    }
                    let userResponsables = [];
                    let enabled = chat.find('[data-champName=enabled]').is(':checked');
                    chat.find('.addNewResponsable[aria-selected="true"]').each(function () {
                        userResponsables.push($(this).find('[data-idUser]').attr('data-idUser'));
                    });

                    $.ajax({
                        type: 'POST',
                        url: "{{ path('changeContentChat_ajax') }}",
                        async: false,
                        dataType: "json",
                        data: {
                            id: id,
                            nom: nom,
                            description: description,
                            userResponsables: userResponsables,
                            enabled: enabled
                        },
                        success: function () {
                            refreshInSection(idSection);
                        }
                    });
                });
            }

            function changeForum(forum) {
                forum.find('.btnSaveInputChange').click(function () {
                    let idSection = $(this).closest('[data-idSection]').attr('data-idSection');
                    let id = forum.attr('data-idItem');
                    let nom = forum.find('[data-champName=nom]').val();
                    let description = forum.find('textarea[data-champName=description]').val();
                    if (CKEDITOR.instances[forum.find('[data-champName=description]').attr('id')]) {
                        description = CKEDITOR.instances[forum.find('[data-champName=description]').attr('id')].getData();
                    }

                    $.ajax({
                        type: 'POST',
                        url: "{{ path('changeContentForum_ajax') }}",
                        async: false,
                        dataType: "json",
                        data: {
                            id: id,
                            nom: nom,
                            description: description
                        },
                        success: function () {
                            refreshInSection(idSection);
                        }
                    });
                });
            }

            function changeLibre(lien) {
                lien.find('.btnSaveInputChange').click(function () {
                    let idSection = $(this).closest('[data-idSection]').attr('data-idSection');
                    let id = lien.attr('data-idItem');
                    let description = lien.find('textarea[data-champName=description]').val();
                    if (CKEDITOR.instances[lien.find('[data-champName=description]').attr('id')]) {
                        description = CKEDITOR.instances[lien.find('[data-champName=description]').attr('id')].getData();
                    }

                    $.ajax({
                        type: 'POST',
                        url: "{{ path('changeContentLibre_ajax') }}",
                        async: false,
                        dataType: "json",
                        data: {
                            id: id,
                            description: description
                        },
                        success: function () {
                            refreshInSection(idSection);
                        }
                    });
                });
            }

            function changeGroupe(groupe) {
                groupe.find('.btnSaveInputChange').click(function () {
                    let idSection = $(this).closest('[data-idSection]').attr('data-idSection');
                    let id = groupe.attr('data-idItem');
                    let nom = groupe.find('[data-champName=nom]').val();
                    let isVertical = groupe.find('.btnSetIsVertical i').hasClass(checkedClass);

                    let description = groupe.find('textarea[data-champName=description]').val();
                    if (CKEDITOR.instances[groupe.find('[data-champName=description]').attr('id')]) {
                        description = CKEDITOR.instances[groupe.find('[data-champName=description]').attr('id')].getData();
                    }

                    $.ajax({
                        type: 'POST',
                        url: "{{ path('changeContentGroupe_ajax') }}",
                        async: false,
                        dataType: "json",
                        data: {
                            id: id,
                            nom: nom,
                            description: description,
                            isVertical: isVertical
                        },
                        success: function () {
                            refreshInSection(idSection);
                        }
                    });
                });
            }

            function changePodcast(podcast) {
                podcast.find('.btnSaveInputChange').click(function () {
                    let idSection = $(this).closest('[data-idSection]').attr('data-idSection');
                    let id = podcast.attr('data-idItem');
                    let nom = podcast.find('[data-champName=nom]').val();

                    let description = podcast.find('textarea[data-champName=description]').val();
                    if (CKEDITOR.instances[podcast.find('[data-champName=description]').attr('id')]) {
                        description = CKEDITOR.instances[podcast.find('[data-champName=description]').attr('id')].getData();
                    }

                    $.ajax({
                        type: 'POST',
                        url: "{{ path('changeContentPodcast_ajax') }}",
                        async: false,
                        dataType: "json",
                        data: {
                            id: id,
                            nom: nom,
                            description: description
                        },
                        success: function () {
                            refreshInSection(idSection);
                        }
                    });
                });
            }

            function changeDevoir(devoir) {
                devoir.find('.btnSaveInputChange').click(function () {
                    let id = devoir.attr('data-idItem');
                    let nom = devoir.find('[data-champName=nom]').val();
                    let description = devoir.find('textarea[data-champName=description]').val();
                    let commentaireCopieRendue = devoir.find('textarea[data-champName=commentaireCopieRendue]').val();
                    if (CKEDITOR.instances[devoir.find('[data-champName=description]').attr('id')]) {
                        description = CKEDITOR.instances[devoir.find('[data-champName=description]').attr('id')].getData();
                    }
                    if (CKEDITOR.instances[devoir.find('[data-champName=commentaireCopieRendue]').attr('id')]) {
                        commentaireCopieRendue = CKEDITOR.instances[devoir.find('[data-champName=commentaireCopieRendue]').attr('id')].getData();
                    }
                    let dureeH = devoir.find('[data-champName=dureeHeures] input').val();
                    let dureeM = devoir.find('[data-champName=dureeMinutes] input').val();
                    let bareme = devoir.find('[data-champName=bareme] input').val();
                    let dateDebut = devoir.find('[data-champName=dateDebut] input').val();
                    let dateFin = devoir.find('[data-champName=dateFin] input').val();
                    let mustReload = $(this).hasClass('mustReload');
                    let idSection = $(this).closest('[data-idSection]').attr('data-idSection');

                    $.ajax({
                        type: 'POST',
                        url: "{{ path('changeContentDevoir_ajax') }}",
                        async: false,
                        dataType: "json",
                        data: {
                            id: id,
                            nom: nom,
                            description: description,
                            dureeH: dureeH,
                            dureeM: dureeM,
                            bareme: bareme,
                            dateDebut: dateDebut,
                            dateFin: dateFin,
                            commentaireCopieRendue: commentaireCopieRendue
                        },
                        success: function () {
                            if (mustReload) {
                                refreshInSection(idSection);
                            } else {
                                devoir.removeClass('inEdition');
                                devoir.find('.btnSaveInputChange').remove();
                            }
                        }
                    });
                });
            }

            // Gestion particilière de l'édition des podcasts
            // tri de ces mp3s
            $('.sortableMp3sInPodcast').sortable({
                placeholder: "ui-state-highlight",
                handle: ".btnMove",
                cancel: ".notSortable",
                stop: function () {
                    let arrayAssocs = [];
                    $(this).find('[data-idMp3]').each(function () {
                        arrayAssocs.push($(this).attr('data-idMp3'));
                    });

                    $.ajax({
                        type: "POST",
                        url: "{{ path('sortMp3InPodcast_ajax') }}",
                        data: {
                            arrayAssocs: arrayAssocs
                        },
                        dataType: "json",
                        success: function (response) {
                            if (!response["error"]) {

                            } else {
                                console.log("Erreur de tri des mp3s");
                            }
                        }
                    });
                }
            });

            // gestion de l'upload
            let urlMp3 = '';
            let urlMp3Dest = '';
            let podcastId = null;
            $('#mp3Upload').fileupload({
                url: steps + upload_srcSteps + upload_course + folderLocation,
                dropZone: null,
                dataType: 'json',
                add: function (e, data) {
                    let uploadErrors = [];
                    if (data.files[0]['size'] > 256000000) {
                        uploadErrors.push('Fichier trop volumineux : ne pas dépasser 256MO');
                    }
                    if (uploadErrors.length > 0) {
                        alert(uploadErrors.join("\n"));
                    } else {
                        data.submit();
                    }
                },
                done: function (e, data) {
                    $.each(data.result.files, function (index, file) {
                        let myUrlTab = file.url.split(folderLocation);
                        $.ajax({
                            type: 'POST',
                            url: "{{ path('uploadMp3Podcast_ajax') }}",
                            async: false,
                            dataType: "json",
                            data: {
                                type: file.type,
                                url: steps + folderLocation + myUrlTab[1],
                                urlDest: urlMp3Dest,
                                currentUrl: window.location.pathname
                            },
                            success: function (data) {
                                urlMp3 = data['newLien'];
                                console.log(urlMp3)
                                $('.btnAddNewMp3ToPodcast').show();
                            },
                            error: function () {
                                $('.modal').modal('toggle');
                            }
                        });
                    });

                },
                progressall: function (e, data) {
                    let progress = parseInt(data.loaded / data.total * 100, 10);
                    $('#itemProgress').find('.progress-bar').css(
                        'width',
                        progress + '%'
                    );
                }
            }).prop('disabled', !$.support.fileInput)
                .parent().addClass($.support.fileInput ? undefined : 'disabled');

            function getUrlMP3dest(){
                // si le folder n'existe pas, on le créé
                let coursId = $('[data-coursId]').attr('data-coursId');
                urlMp3Dest = steps + folderLocation + coursId + '/podcasts/' + podcastId + '/';
                $.ajax({
                    type: 'POST',
                    url: "{{ path('checkDirForUploadFile_ajax') }}",
                    async: false,
                    dataType: "json",
                    data: {
                        url: urlMp3Dest
                    },
                    success: function (data) {
                    },
                    error: function (xhr, status, error) {
                    }
                });
            }

            $('.selectMp3ToAddToPodcast').click(function () {
                // On commence par sauvegarder le podcast s'il était en cours d'édition
                let podcast = $(this).closest('.courseElemAdmin');
                if (podcast.find('.btnSaveInputChange')) {
                    podcast.find('.btnSaveInputChange').click();
                }
                podcastId = podcast.attr('data-idItem');

                $('[data-contentModal=ajoutMp3ToPodcast] [data-champName=podcastNewMp3_url]').hide().val('');
                $('[data-contentModal=ajoutMp3ToPodcast] [data-champName=podcastNewMp3_nom]').val('');
                CKEDITOR.instances['newMp3InPodcastDescription'].setData('');

                // puis, on affiche la popup d'ajout d'un mp3
                let idSection = $('.ongletSection.active').attr('data-idSection');
                $('.modal').modal();
                $('.modal .modal-body').hide();
                $('.modal .modal-body[data-contentModal=ajoutMp3ToPodcast]').attr('data-idPodcast', $(this).closest('[data-typeitem=podcast]').attr('data-iditem')).show();

                $('.alertMustBeSet').removeClass('alertMustBeSet');

                getUrlMP3dest();

                $('.btnAddNewMp3ToPodcast').hide().unbind('click').click(function () {
                    $('.alertMustBeSet').removeClass('alertMustBeSet');
                    let nomMp3 = $('[data-contentModal=ajoutMp3ToPodcast] [data-champName=podcastNewMp3_nom]').val();
                    let descriptionMp3 = CKEDITOR.instances['newMp3InPodcastDescription'].getData();

                    if (nomMp3 === "") {
                        $('[data-contentModal=ajoutMp3ToPodcast] [data-champName=nomMp3]').addClass('alertMustBeSet');
                    } else {
                        $.ajax({
                            type: 'POST',
                            url: "{{ path('addMp3_ajax') }}",
                            async: false,
                            dataType: "json",
                            data: {
                                idMp3:'0',
                                nom: nomMp3,
                                description: descriptionMp3,
                                url: urlMp3,
                                podcastId: podcastId
                            },
                            success: function () {
                                refreshInSection(idSection);
                            }
                        });
                    }
                });
            });
            // suppression d'un mp3 d'un podcast
            $('.btnRemoveMp3FromPodcast').click(function () {
                let mp3 = $(this).closest('[data-idMp3]');
                podcastId = $(this).closest('.courseElemAdmin').attr('data-idItem');
                $.ajax({
                    type: 'POST',
                    url: "{{ path('removeMp3Podcasts_ajax') }}",
                    async: false,
                    dataType: "json",
                    data: {
                        mp3Id: mp3.attr('data-idMp3')
                    },
                    success: function () {
                        mp3.remove();
                        changeMp3PodcastRssFile(podcastId, false);
                    }
                });
            });
            // changement de la visibilité d'un mp3 de podcast
            $('.btnMp3Visibility').click(function () {
                let iconeBtn = $(this).find('i');
                let mp3 = $(this).closest('[data-idMp3]');
                podcastId = $(this).closest('.courseElemAdmin').attr('data-idItem');
                $.ajax({
                    type: 'POST',
                    url: "{{ path('toggleVisibilityMp3Podcast_ajax') }}",
                    async: false,
                    dataType: "json",
                    data: {
                        mp3Id: mp3.attr('data-idMp3')
                    },
                    success: function (response) {
                        if (response['isVisible']) {
                            iconeBtn.removeClass('fa-eye-slash').addClass('fa-eye');
                        } else {
                            iconeBtn.removeClass('fa-eye').addClass('fa-eye-slash');
                        }
                        changeMp3PodcastRssFile(podcastId, false);
                    }
                });
            });
            // édition d'un Mp3 d'un podcast
            $('.btnEditMp3InPocast').click(function () {
                let mp3 = $(this).closest('[data-idMp3]');
                let podcast = $(this).closest('.courseElemAdmin');
                podcastId = podcast.attr('data-idItem');
                urlMp3 = '';

                $('.modal').modal();
                $('.modal .modal-body').hide();
                $('.modal .modal-body[data-contentModal=ajoutMp3ToPodcast]').show();

                $('.alertMustBeSet').removeClass('alertMustBeSet');

                getUrlMP3dest();

                $.ajax({
                    type: 'POST',
                    url: "{{ path('getMp3Podcast_ajax') }}",
                    async: false,
                    dataType: "json",
                    data: {
                        idMp3: mp3.attr('data-idMp3')
                    },
                    success: function (data) {
                        urlMp3 = data['urlMp3'];
                        $('[data-contentModal=ajoutMp3ToPodcast] [data-champName=podcastNewMp3_nom]').val(data['nomMp3']);
                        $('[data-contentModal=ajoutMp3ToPodcast] [data-champName=podcastNewMp3_url]').show().val(data['urlMp3']);

                        CKEDITOR.instances['newMp3InPodcastDescription'].setData(data['descrMp3']);
                    }
                });

                $('.btnAddNewMp3ToPodcast').unbind('click').click(function () {
                    $('.alertMustBeSet').removeClass('alertMustBeSet');
                    let nomMp3 = $('[data-contentModal=ajoutMp3ToPodcast] [data-champName=podcastNewMp3_nom]').val();
                    let descriptionMp3 = CKEDITOR.instances['newMp3InPodcastDescription'].getData();

                    if (nomMp3 === "") {
                        $('[data-contentModal=ajoutMp3ToPodcast] [data-champName=nomMp3]').addClass('alertMustBeSet');
                    } else {
                        console.log('addMp3_ajax '+urlMp3)
                        $.ajax({
                            type: 'POST',
                            url: "{{ path('addMp3_ajax') }}",
                            async: false,
                            dataType: "json",
                            data: {
                                idMp3:mp3.attr('data-idMp3'),
                                nom: nomMp3,
                                description: descriptionMp3,
                                url: urlMp3,
                                podcastId: podcastId
                            },
                            success: function () {
                                changeMp3PodcastRssFile(podcastId, true);
                            }
                        });
                    }
                });
            });

            function changeMp3PodcastRssFile(podcastId, mustRefresh) {
                let idSection = $('.ongletSection.active').attr('data-idSection');
                $.ajax({
                    type: 'POST',
                    url: "{{ path('changeContentMp3PodcastRssFile_ajax') }}",
                    async: false,
                    dataType: "json",
                    data: {
                        id: podcastId
                    },
                    success: function () {
                        if(mustRefresh){
                            refreshInSection(idSection);
                        }
                    }
                });
            }

            // Gestion particilière de l'édition des groupes de liens
            // tri de ces liens
            $('.sortableLiensInGroupe').sortable({
                placeholder: "ui-state-highlight",
                handle: ".btnMove",
                cancel: ".notSortable",
                stop: function () {
                    let arrayAssocs = [];
                    $(this).find('[data-idLien]').each(function () {
                        arrayAssocs.push($(this).attr('data-idLien'));
                    });

                    $.ajax({
                        type: "POST",
                        url: "{{ path('sortGroupeLiensAssocs_ajax') }}",
                        data: {
                            arrayAssocs: arrayAssocs
                        },
                        dataType: "json",
                        success: function (response) {
                            if (!response["error"]) {

                            } else {
                                console.log("Erreur de tri des sections");
                            }
                        }
                    });
                }
            });
            // on passe les listes en vertical dans un groupe
            $('.btnSetIsVertical').click(function () {
                let groupe = $(this).closest('.courseElemAdmin');
                let btn = $(this).find('i');
                if (btn.hasClass(uncheckedClass)) {
                    btn.removeClass(uncheckedClass).addClass(checkedClass);
                } else {
                    btn.removeClass(checkedClass).addClass(uncheckedClass);
                }
                detectInput(groupe);
            });

            // ajout d'un lien dans un groupe
            $('.selectLienToAddToGroupe').click(function () {
                // On commence par sauvegarder le groupe s'il était en cours d'édition
                let groupe = $(this).closest('.courseElemAdmin');
                if (groupe.find('.btnSaveInputChange')) {
                    groupe.find('.btnSaveInputChange').click();
                }

                // puis, on affiche la popup d'ajout d'un lien
                let idSection = $('.ongletSection.active').attr('data-idSection');
                $('.modal').modal();
                $('.modal .modal-body').hide();
                $('.modal .modal-body[data-contentModal=ajoutLienToGroupe]').attr('data-idGroupe', $(this).closest('[data-typeitem=groupe]').attr('data-iditem')).show();

                $('.alertMustBeSet').removeClass('alertMustBeSet');

                $('.btnAddNewLienToGroupe').unbind('click').click(function () {
                    $('.alertMustBeSet').removeClass('alertMustBeSet');
                    let nomLienInGroupe = $(this).closest('.modal-body').find('[data-champName=nomLienInGroupe]').val();
                    let selectedIdCat = $('[data-id=categorieLienInGroupeSelectPicker] [data-idcat]');
                    let categorieLienInGroupe = selectedIdCat.attr('data-idcat');

                    let nomLien = $('[data-contentModal=ajoutLienToGroupe] [data-champName=groupeNewLien_nom]').val();
                    let urlLien = $('[data-contentModal=ajoutLienToGroupe] [data-champName=groupeNewLien_url]').val();
                    let descriptionLien = CKEDITOR.instances['newLienInGroupDescription'].getData();
                    let selectedIdType = $('[data-id=typeLienInGroupeSelectPicker] [data-idType]');
                    let typeLien = selectedIdType.attr('data-idType');

                    if (nomLienInGroupe === "") {
                        $('[data-contentModal=ajoutLienToGroupe] [data-champName=nomLienInGroupe]').addClass('alertMustBeSet');
                    } else if (selectedIdCat.length === 0) {
                        $('[data-contentModal=ajoutLienToGroupe] [data-id=categorieLienInGroupeSelectPicker]').addClass('alertMustBeSet');
                    } else if (selectedIdType.length === 0) {
                        $('[data-contentModal=ajoutLienToGroupe] [data-id=typeLienInGroupeSelectPicker]').addClass('alertMustBeSet');
                    } else {
                        let groupeId = $(this).closest('[data-idGroupe]').attr('data-idGroupe');
                        $.ajax({
                            type: 'POST',
                            url: "{{ path('addLien_ajax') }}",
                            async: false,
                            dataType: "json",
                            data: {
                                typeLien: typeLien,
                                nom: nomLien,
                                description: descriptionLien,
                                url: urlLien,
                                idCours: $('[data-coursId]').attr('data-coursId')
                            },
                            success: function (data) {
                                let lienId = data['id'];
                                $.ajax({
                                    type: 'POST',
                                    url: "{{ path('addLienGroupe_ajax') }}",
                                    async: false,
                                    dataType: "json",
                                    data: {
                                        groupeId: groupeId,
                                        lienId: lienId,
                                        nomLien: nomLienInGroupe,
                                        categorieId: categorieLienInGroupe
                                    },
                                    success: function () {
                                        if (urlLien === "") {
                                            uploadLinkFile(lienId, true, idSection);
                                        } else {
                                            refreshInSection(idSection);
                                        }
                                    }
                                });
                            }
                        });
                    }
                });

                $('.btnAddLienToGroupe').unbind('click').click(function () {
                    $('.alertMustBeSet').removeClass('alertMustBeSet');
                    let nomLienInGroupe = $(this).closest('.modal-body').find('[data-champName=nomLienInGroupe]').val();
                    let selectedIdCat = $('[data-id=categorieLienInGroupeSelectPicker] [data-idcat]');
                    let categorieLienInGroupe = selectedIdCat.attr('data-idcat');

                    if (nomLienInGroupe === "") {
                        $('[data-champName=nomLienInGroupe]').addClass('alertMustBeSet');
                    } else if (selectedIdCat.length === 0) {
                        $('[data-id=categorieLienInGroupeSelectPicker]').addClass('alertMustBeSet');
                    } else {
                        let groupeId = $(this).closest('[data-idGroupe]').attr('data-idGroupe');
                        let lienId = $(this).closest('[data-typeitem]').attr('data-iditem');
                        $.ajax({
                            type: 'POST',
                            url: "{{ path('addLienGroupe_ajax') }}",
                            async: false,
                            dataType: "json",
                            data: {
                                groupeId: groupeId,
                                lienId: lienId,
                                nomLien: nomLienInGroupe,
                                categorieId: categorieLienInGroupe
                            },
                            success: function () {
                                refreshInSection(idSection);
                            }
                        });
                    }

                });
            });
            // suppression d'un lien d'un groupe
            $('.btnRemoveLienFromGroup').click(function () {
                let lien = $(this).closest('[data-idlien]');
                let idAssoc = lien.attr('data-idlien');
                $.ajax({
                    type: 'POST',
                    url: "{{ path('removeLienGroupe_ajax') }}",
                    async: false,
                    dataType: "json",
                    data: {
                        idAssoc: idAssoc
                    },
                    success: function () {
                        lien.remove();
                    }
                });
            });
            $('.btnEditLienInGroup').click(function () {
                let lien = $(this).closest('[data-idlien]');
                let idAssoc = lien.attr('data-idlien');
                $('.modal').modal();
                $('.modal .modal-body').hide();
                $('.modal .modal-body[data-contentModal=editLienInGroupe]').show();

                $('.alertMustBeSet').removeClass('alertMustBeSet');

                $.ajax({
                    type: 'POST',
                    url: "{{ path('getLienGroupe_ajax') }}",
                    async: false,
                    dataType: "json",
                    data: {
                        idAssoc: idAssoc
                    },
                    success: function (data) {
                        $('[data-contentModal=editLienInGroupe] [data-champName=nomLienInGroupe]').val(data['nomAssoc']);
                        $('[data-contentModal=editLienInGroupe] [data-champName=groupeNewLien_nom]').val(data['nomLien']);
                        $('[data-contentModal=editLienInGroupe] [data-champName=groupeNewLien_url]').val(data['urlLien']);

                        CKEDITOR.instances['editLienInGroupDescription'].setData(data['descrLien']);

                        $('#categorieEditLienInGroupeSelectPicker').selectpicker('val', data['catAssoc']);
                        $('#typeEditLienInGroupeSelectPicker').selectpicker('val', data['typeLien']);
                    }
                });

                $('.btnSaveEditLienInGroupe').unbind('click').click(function () {
                    let selectedIdType = $('[data-id=typeEditLienInGroupeSelectPicker] [data-idType]');
                    let typeLien = selectedIdType.attr('data-idType');
                    let selectedIdCat = $('[data-id=categorieEditLienInGroupeSelectPicker] [data-idcat]');
                    let categorieLienInGroupe = selectedIdCat.attr('data-idcat');

                    let nomAssoc = $('[data-contentModal=editLienInGroupe] [data-champName=nomLienInGroupe]').val();

                    $.ajax({
                        type: 'POST',
                        url: "{{ path('editLienGroupe_ajax') }}",
                        async: false,
                        dataType: "json",
                        data: {
                            idAssoc: idAssoc,
                            nomAssoc: nomAssoc,
                            nomLien: $('[data-contentModal=editLienInGroupe] [data-champName=groupeNewLien_nom]').val(),
                            urlLien: $('[data-contentModal=editLienInGroupe] [data-champName=groupeNewLien_url]').val(),
                            descrLien: CKEDITOR.instances['editLienInGroupDescription'].getData(),
                            typeLienId: typeLien,
                            categorieLienId: categorieLienInGroupe

                        },
                        success: function () {
                            lien.find('.nomAssoc').text(nomAssoc);
                            $('.modal').modal('toggle');
                        }
                    });
                });
            });

            // met à jour les noms de responsables des chats
            $('.chatAdminSelectPicker').each(function () {
                let randomInt = Math.floor((Math.random() * 100000) + 1);
                let idsAdmins = [];
                let idItem = $(this).closest('[data-iditem]').attr('data-iditem');
                let oldidSP = 'MyBtnSelectPicker' + idItem;
                let idSP = oldidSP + '-' + randomInt;
                $(this).find('.MyBtnSelectPicker [data-id=' + oldidSP + ']').attr('data-id', idSP);
                $(this).find('.selectpicker').attr('id', idSP);
                $(this).find('.responsablesIds span').each(function () {
                    idsAdmins.push($(this).text());
                });
                if (idsAdmins.length) {
                    $('#' + idSP).selectpicker('val', idsAdmins);
                }
            });

            // reset les input text pour éviter le cache
            $('.inputReset').val('');

            // force les select option selected (car pb sur les types de liens ça ne se met pas à jour...)
            $('select').each(function () {
                $(this).val($(this).find("[selected=selected]").attr('value'));
            });

            function updateCheckedState(btn, isVisible) {
                if (isVisible) {
                    btn.removeClass(uncheckedClass).addClass(checkedClass);
                } else {
                    btn.removeClass(checkedClass).addClass(uncheckedClass);
                }
            }

            let getUrlParameter = function getUrlParameter(sParam) {
                let sPageURL = decodeURIComponent(window.location.search.substring(1)),
                    sURLVariables = sPageURL.split('&'),
                    sParameterName,
                    i;

                for (i = 0; i < sURLVariables.length; i++) {
                    sParameterName = sURLVariables[i].split('=');

                    if (sParameterName[0] === sParam) {
                        return sParameterName[1] === undefined ? true : sParameterName[1];
                    }
                }
            };
            // on clique sur la section passée en paramètre (si reload de la page)
            if (getUrlParameter("idSection")) {
                $('.ongletSection[data-idsection=' + getUrlParameter("idSection") + '] a').click();
            } else if (getUrlParameter("sectionAdmin")) {
                $('#sectionAdmin a').click();
            } else if (getUrlParameter("ressourcesAdmin")) {
                $('#ressourcesAdmin a').click();
            }

            // upload d'un fichier pour un lien
            function uploadLinkFile(lienId, refresh, idSection) {
                let coursId = $('[data-coursId]').attr('data-coursId');
                let lienUrlInput = $('[data-typeItem=lien][data-idItem=' + lienId + '] .champAdmin[data-champName=url]');

                $('.modal').modal();
                $('.modal .modal-body').hide();
                $('.modal .modal-body[data-contentModal=uploadFile]').attr('data-idItem', lienId).show();

                // si le folder n'existe pas, on le créé
                let url = steps + folderLocation + coursId + '/lien/' + lienId + '/';

                $.ajax({
                    type: 'POST',
                    url: "{{ path('checkDirForUploadFile_ajax') }}",
                    async: false,
                    dataType: "json",
                    data: {
                        url: url
                    },
                    success: function (data) {
                    },
                    error: function (xhr, status, error) {
                    }
                });

                $('.modal .modal-body[data-contentModal=uploadFile] .bginverse').empty().append(
                    '<div>' +
                    '<div class="mb-10" style="text-align: center">' +
                    '<div class="LabelAdmin col-xs-8">Dézipper le fichier (le fichier index.html sera pointé par le lien)</div>' +
                    '<input data-champName="unzipUploaded" class="col-xs-2" value="" type="checkbox" />' +
                    '</div>' +
                    '</div>' +
                    '<div class="fileUploader btn">' +
                    '<span class="btn btn-success fileinput-button"> ' +
                    '<i class="glyphicon glyphicon-plus"></i> ' +
                    '<span>Ajouter un fichier</span> ' +
                    '<input id="itemUpload" type="file" name="files[]" multiple> ' +
                    '</span> ' +
                    '<div id="itemProgress" class="progress col-xs-12"> ' +
                    '   <div class="progress-bar progress-bar-success"></div> ' +
                    '</div> ' +
                    '</div>'
                );


                $('#itemUpload').fileupload({
                    url: steps + upload_srcSteps + upload_course + folderLocation,
                    dropZone: null,
                    dataType: 'json',
                    add: function (e, data) {
                        let uploadErrors = [];
                        if (data.files[0]['size'] > 256000000) {
                            uploadErrors.push('Fichier trop volumineux : ne pas dépasser 256MO');
                        }
                        if (uploadErrors.length > 0) {
                            alert(uploadErrors.join("\n"));
                        } else {
                            data.submit();
                        }
                    },
                    done: function (e, data) {
                        $.each(data.result.files, function (index, file) {
                            let myUrlTab = file.url.split(folderLocation);
                            $.ajax({
                                type: 'POST',
                                url: "{{ path('uploadLien_ajax') }}",
                                async: false,
                                dataType: "json",
                                data: {
                                    itemId: lienId,
                                    type: file.type,
                                    url: steps + folderLocation + myUrlTab[1],
                                    urlDest: url,
                                    unzipIfZip: $('[data-champName=unzipUploaded]').prop('checked'),
                                    currentUrl: window.location.pathname
                                },
                                success: function (data) {
                                    $('.modal').modal('toggle');
                                    lienUrlInput.val(data.newLien);
                                    if (refresh) {
                                        refreshInSection(idSection);
                                    }
                                },
                                error: function () {
                                    $('.modal').modal('toggle');
                                }
                            });
                        });

                    },
                    progressall: function (e, data) {
                        let progress = parseInt(data.loaded / data.total * 100, 10);
                        $('#itemProgress').find('.progress-bar').css(
                            'width',
                            progress + '%'
                        );
                    }
                }).prop('disabled', !$.support.fileInput)
                    .parent().addClass($.support.fileInput ? undefined : 'disabled');
            }

            $('.lienAdmin .fileUploader').click(function () {
                uploadLinkFile($(this).attr('data-idItem'), false, null);
            });


            // upload d'un fichier pour un sujet de devoir ou pour un corrige type
            $('.selectSujetAddToDevoir, .selectCorrigeTypeAddToDevoir').click(function () {
                let idSection = $(this).closest('.section').attr('data-idSection');
                let devoir = $(this).closest('[data-typeitem=devoir]');
                let devoirId = devoir.attr('data-iditem');
                let coursId = $('[data-coursId]').attr('data-coursId');

                $('.modal').modal();
                $('.modal .modal-body').hide();
                $('.modal .modal-body[data-contentModal=uploadFile]').attr('data-idItem', devoirId).show();

                // si le folder n'existe pas, on le créé
                let typeItem = "sujets";
                let titreDefaut = "Sujet du devoir";
                if ($(this).hasClass("selectCorrigeTypeAddToDevoir")) {
                    typeItem = "corrigeTypes";
                    titreDefaut = "Corrigé type du devoir";
                }
                let rand = Math.floor((Math.random() * 10000) + 1);
                let url = steps + folderLocation + coursId + '/devoir/' + devoirId + '/' + typeItem + '/' + rand + '/';

                $.ajax({
                    type: 'POST',
                    url: "{{ path('checkDirForUploadFile_ajax') }}",
                    async: false,
                    dataType: "json",
                    data: {
                        url: url
                    },
                    success: function (data) {
                    },
                    error: function (xhr, status, error) {
                    }
                });

                $('.modal .modal-body[data-contentModal=uploadFile] .bginverse').empty().append(
                    '<div>' +
                    '<div class="mb-10" style="text-align: left">' +
                    '<div>Nom du document</div> ' +
                    '<input id="inputFileName" data-champName="uploadedFileName" class="col-xs-12" value="" type="text" />' +
                    '<div class="alternative">' +
                    '<div>Url</div> ' +
                    '<input id="inputFileURL" data-champName="inputFileURL" class="col-xs-12" value="" type="text" />' +
                    '<div style="text-align: center"><a style="margin: 20px" class="btn btn-primary btn-sm btnValidURLress">Valider une URL</a>OU Déposez un ficher</div>' +
                    '</div>' +
                    '<div class="LabelAdmin col-xs-8">Dézipper le fichier (le fichier index.html sera pointé par le lien)</div>' +
                    '<input data-champName="unzipUploaded" class="col-xs-2" value="" type="checkbox" />' +
                    '</div>' +
                    '</div>' +

                    '<div class="fileUploader btn">' +
                    '<span class="btn btn-success fileinput-button"> ' +
                    '<i class="glyphicon glyphicon-plus"></i> ' +
                    '<span>Ajouter un fichier</span> ' +
                    '<input id="itemUpload" type="file" name="files[]" multiple> ' +
                    '</span> ' +
                    '<div id="itemProgress" class="progress col-xs-12"> ' +
                    '<div class="progress-bar progress-bar-success"></div> ' +
                    '</div> ' +
                    '</div>'
                );


                $('.modal .modal-body[data-contentModal=uploadFile] [data-champName=uploadedFileName]').val(titreDefaut);

                $('.btnValidURLress').click(function () {
                    $.ajax({
                        type: 'POST',
                        url: "{{ path('validURLress_ajax') }}",
                        async: false,
                        dataType: "json",
                        data: {
                            typeItem: typeItem,
                            itemId: devoirId,
                            urlDest: $('.modal .modal-body[data-contentModal=uploadFile] [data-champName=inputFileURL]').val(),
                            nom: $('.modal .modal-body[data-contentModal=uploadFile] [data-champName=uploadedFileName]').val()
                        },
                        success: function () {
                            $('.modal').modal('toggle');
                            if (devoir.find('.btnSaveInputChange').length) {
                                devoir.find('.btnSaveInputChange').addClass('mustReload');
                                devoir.find('.btnSaveInputChange').click();
                            } else {
                                refreshInSection(idSection);
                            }
                        },
                        error: function () {
                            $('.modal').modal('toggle');
                        }
                    });
                });

                $('#itemUpload').fileupload({
                    url: steps + upload_srcSteps + upload_course + folderLocation,
                    dropZone: null,
                    dataType: 'json',
                    add: function (e, data) {
                        let uploadErrors = [];
                        if (data.files[0]['size'] > 256000000) {
                            uploadErrors.push('Fichier trop volumineux : ne pas dépasser 256MO');
                        }
                        if (uploadErrors.length > 0) {
                            alert(uploadErrors.join("\n"));
                        } else {
                            data.submit();
                        }
                    },
                    done: function (e, data) {
                        $.each(data.result.files, function (index, file) {
                            let myUrlTab = file.url.split(folderLocation);
                            $.ajax({
                                type: 'POST',
                                url: "{{ path('uploadDevoirFile_ajax') }}",
                                async: false,
                                dataType: "json",
                                data: {
                                    type: file.type,
                                    unzipIfZip: $('[data-champName=unzipUploaded]').prop('checked'),
                                    typeItem: typeItem,
                                    itemId: devoirId,
                                    url: steps + folderLocation + myUrlTab[1],
                                    urlDest: url,
                                    currentUrl: window.location.pathname,
                                    nom: $('.modal .modal-body[data-contentModal=uploadFile] [data-champName=uploadedFileName]').val()
                                },
                                success: function () {
                                    $('.modal').modal('toggle');
                                    if (devoir.find('.btnSaveInputChange').length) {
                                        devoir.find('.btnSaveInputChange').addClass('mustReload');
                                        devoir.find('.btnSaveInputChange').click();
                                    } else {
                                        refreshInSection(idSection);
                                    }
                                },
                                error: function () {
                                    $('.modal').modal('toggle');
                                }
                            });
                        });

                    },
                    progressall: function (e, data) {
                        let progress = parseInt(data.loaded / data.total * 100, 10);
                        $('#itemProgress').find('.progress-bar').css(
                            'width',
                            progress + '%'
                        );
                    }
                }).prop('disabled', !$.support.fileInput)
                    .parent().addClass($.support.fileInput ? undefined : 'disabled');
            });

            // tri des corrigés et des sujets
            $('.sortableDevoirFile').sortable({
                placeholder: "ui-state-highlight",
                handle: ".btnMove",
                cancel: ".notSortable",
                stop: function (event, ui) {
                    let elementCible = "DevoirCorrigeType";
                    if ($(this).hasClass('sortableSujetDevoir')) {
                        elementCible = "DevoirSujet";
                    }
                    let arrayFile = [];
                    let itemDropped = ui.item;
                    let id = itemDropped.attr('data-idFile');
                    $(this).find('[data-idFile]').each(function () {
                        arrayFile.push($(this).attr('data-idFile'));
                    });

                    $.ajax({
                        type: "POST",
                        url: "{{ path('sortDevoirFile_ajax') }}",
                        data: {
                            arrayFile: arrayFile,
                            elementCible: elementCible
                        },
                        dataType: "json",
                        success: function (response) {
                            if (!response["error"]) {

                            } else {
                                console.log("Erreur de tri des sections");
                            }
                        }
                    });
                }
            });
            $('.btnRemoveSujetFromDevoir, .btnRemoveCorrigeTypeFromDevoir').click(function () {
                let typeItem = "sujet";
                if ($(this).hasClass("btnRemoveCorrigeTypeFromDevoir")) {
                    typeItem = "corrigeType";
                }
                let item = $(this).closest('[data-idfile]');
                let idItem = item.attr('data-idfile');

                $.ajax({
                    type: 'POST',
                    url: "{{ path('removeDevoirFile_ajax') }}",
                    async: false,
                    dataType: "json",
                    data: {
                        typeItem: typeItem,
                        itemId: idItem
                    },
                    success: function () {
                        item.remove();
                    },
                    error: function () {
                        console.log("error");
                    }
                });
            });

            // ajout des dateTimePicker pour les dates de début et de fin
            $('.datePickerEvtGroup').each(function () {
                let dateD = $(this).find('.evtDateD');
                let dateF = $(this).find('.evtDateF');
                dateD.datetimepicker({
                    locale: 'fr',
                    date: toJSDate(dateD.attr('data-date'))
                });

                dateF.datetimepicker({
                    locale: 'fr',
                    useCurrent: false,
                    date: toJSDate(dateF.attr('data-date'))
                });
                dateD.on("dp.change", function (e) {
                    dateF.data("DateTimePicker").minDate(e.date);
                    let elem = $(this).closest('.courseElemAdmin');
                    detectInput(elem);
                });
                dateF.on("dp.change", function (e) {
                    dateD.data("DateTimePicker").maxDate(e.date);
                    let elem = $(this).closest('.courseElemAdmin');
                    detectInput(elem);
                });
            });

            function toJSDate(phpDateTime) {
                let dateTime = phpDateTime.split(" ");//dateTime[0] = date, dateTime[1] = time

                let date = dateTime[0].split("-");
                let time = dateTime[1].split(":");

                return new Date(date[0], (date[1] - 1), date[2], time[0], time[1], 0, 0);
            }

            // champ durée
            $('.bootstrapNumber').bootstrapNumber();
            $('.devoirAdmin button').click(function () {
                let elem = $(this).closest('.courseElemAdmin');
                detectInput(elem);
            });

            // activation des documents
            $('.activationDocBtn').click(function () {
                let id = $(this).closest('[data-coursId]').attr('data-coursId');
                let isVisible = $(this).hasClass(checkedClass);
                let myBtn = $(this);
                $.ajax({
                    type: "POST",
                    url: "{{ path('changeActivationDocsCours_ajax') }}",
                    data: {
                        id: id,
                        isVisible: isVisible
                    },
                    dataType: "json",
                    success: function () {
                        if (isVisible) {
                            myBtn.removeClass(checkedClass).addClass(uncheckedClass);
                            myBtn.closest('[data-activated]').attr('data-activated', "0");
                        } else {
                            myBtn.removeClass(uncheckedClass).addClass(checkedClass);
                            myBtn.closest('[data-activated]').attr('data-activated', "1");
                        }
                    }
                });
            });

            $('#intituleSharedDocs').on('input', function () {
                let input = $(this).val();
                let id = $(this).closest('[data-coursId]').attr('data-coursId');
                if (input === "") {
                    $('.headingSharedDocs').text('Mes documents partagés');
                } else {
                    $('.headingSharedDocs').text(input);
                }
                $('.headingSharedDocs').addClass('unvalidated');
                $('.btnValidateSharedDocsIntitule').removeClass('btnDesactivated').unbind('click').click(function () {
                    $.ajax({
                        type: "POST",
                        url: "{{ path('updateIntituleSharedDocsCours_ajax') }}",
                        data: {
                            id: id,
                            input: input
                        },
                        dataType: "json",
                        success: function () {
                            $('.btnValidateSharedDocsIntitule').addClass('btnDesactivated');
                            $('.headingSharedDocs').removeClass('unvalidated');
                        }
                    });
                });

            });

        });

    </script>


    <div class="container mt-140" data-coursId="{{ cours.id }}" data-folderUpload="{{ folderUpload }}"
         data-uploadSteps="{{ uploadSteps }}" data-uploadSrcSteps="{{ uploadSrcSteps }}"
         data-courseUpload="{{ uploadCourse }}">
        <div class="row">
            <div class="col-sm-3">
                <div class="course-intro">
                    <img src="{{ asset('images/cours/') }}{{ cours.imageFilename }}" class="img-responsive" alt="">
                </div>
            </div>
            <div class="col-sm-9">
                <div class="course-full">
                    <h2 class="heading">{{ cours.nom }}</h2>

                    <div class="personal">
                        <!--<div>
                            <span>Enseignant</span>
                            <span>M. prof de math <a href="teacher-profile.html"><i class="fa fa fa-user"></i>
                                </a></span>
                        </div>
                        <div>
                        </div>-->
                    </div>
                    <div class="editor">
                        {{ cours.accueil | raw }}
                    </div>
                </div>
            </div>
        </div>

        <div class="clearfix"></div>
        <div class="row mt-40 mb-100">

            <!--- Menu des sections sur la gauche -->
            <div class="col-md-3 col-sm-3 col-xs-12">
                <ul class="nav nav-pills nav-stacked pull-left" role="tablist"
                    style="padding-bottom: 5px;padding-top: 5px">

                    <!--- section fictive : pour l'admin -->
                    <li role="presentation" class="active ongletAdmin" id="sectionAdmin">
                        <a href="#t1body_0" aria-controls="t1body_0" role="tab"
                           data-toggle="tab" aria-expanded="true"><i class="fa fa-cogs fa-fw" aria-hidden="true"> </i>
                            Gestion des sections
                        </a>
                    </li>
                    {% if isReferent or app.user.hasRole('ROLE_SUPER_ADMIN') %}
                        <li role="presentation" class="ongletAdmin stockRessource" id="ressourcesAdmin">
                            <a href="#t1body_1" aria-controls="t1body_1" role="tab"
                               data-toggle="tab" aria-expanded="true"><i class="fa fa-cogs fa-fw"
                                                                         aria-hidden="true"> </i>
                                Stock de ressources
                            </a>
                        </li>
                    {% endif %}

                    <!--- sections -->
                    {% for key,val in zonesSections %}
                        <li role="presentation" class="ongletSection visibility_{{ val.section.isVisible }} acces_condition_{{ val.section.isAccesConditionne }}"
                            data-idsection="{{ val.section.id }}">
                            <a href="#t1body{{ val.section.id }}" aria-controls="t1body{{ val.section.id }}" role="tab"
                               data-toggle="tab" aria-expanded="true">
                                <i class="fa {{ val.section.faIcon }} fa-fw" aria-hidden="true"> </i><span
                                        class="nomSection">{{ val.section.nom }}</span>
                            </a>
                        </li>
                    {% endfor %}

                    <!-- Documents -->
                    {% if isReferent or app.user.hasRole('ROLE_SUPER_ADMIN') %}
                        <li role="presentation" class="ongletAdmin">
                            <a href="#sectionDocs" aria-controls="sectionDocs" role="tab" data-toggle="tab"
                               aria-expanded="true"><i class="fa fa-pencil fa-fw"
                                                       aria-hidden="true"> </i>{% if cours.intituleSharedDocs != "" %}
                                {{ cours.intituleSharedDocs }}
                            {% else %}
                                Documents partagés
                                {% endif %}</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
            <div class="col-md-9 col-sm-9 col-xs-12 sectionAdminContent">
                <div class="tab-content">

                    <!--- administration des sections (activation, modif nom et suppression) -->
                    <div role="tabpanel" class="tab-pane fade in active sortable" id="t1body_0">
                        <div class="sortableSections">
                            {% for key,val in zonesSections %}
                                <div class="row mb-10 adminSectionRow visibility_{{ val.section.isVisible }}"
                                     data-idSection="{{ val.section.id }}">
                                    <div class="myBtn btnAdmin btnLeft col-sm-1  col-xs-1">
                                        {% if val.section.isVisible %}
                                            <i class="activationSectionBtn fa fa-check-square-o"></i>
                                        {% else %}
                                            <i class="activationSectionBtn fa fa-square-o"></i>
                                        {% endif %}
                                    </div>
                                    <div class="myBtn btnAdmin btnMove btnMoveSection col-sm-1  col-xs-1"><i
                                                class="fa fa-arrows-alt "></i></div>
                                    <input data-champName="nom" class="nomSectionInput col-sm-6  col-xs-6"
                                           value="{{ val.section.nom }}"/>
                                    <input data-champName="faIcon" class="faIconSectionInput col-sm-2 col-xs-2"
                                           value="{{ val.section.faIcon }}"/>
                                    {% if app.user.hasRole('ROLE_SUPER_ADMIN') or isReferent %}
                                        <div class="myBtn btnRight btnAdmin btnSupprElem btnDeleteSection col-sm-1 col-xs-1">
                                            <i class="fa fa-trash"></i></div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        <div class="row mb-10 adminSectionRow mt-40 notSortable">
                            <input data-champName="nom"
                                   class="inputReset nomSectionAddInput col-sm-6  col-xs-6 col-xs-push-2"
                                   placeholder="Ajouter une nouvelle section"/>
                            <div class="myBtn btnRight btnAdmin btnAddSection col-sm-1 col-xs-1 col-xs-push-2"><i
                                        class="fa fa-plus"></i></div>
                        </div>
                    </div>

                    <!--- administration des ressources (CRUD) -->
                    <div role="tabpanel" class="tab-pane fade" id="t1body_1">
                        <ul class="nav nav-tabs" role="tablist">
                            <li role="presentation" class="active"><a href="#btnListLien" aria-controls="btnListLien"
                                                                      role="tab" data-toggle="tab"><i
                                            class="fa fa-external-link  fa-fw"></i> Lien</a></li>
                            <li role="presentation"><a href="#btnListDevoir" aria-controls="btnListDevoir" role="tab"
                                                       data-toggle="tab"><i class="fa fa-university fa-fw"></i>
                                    Devoir</a></li>
                            <li role="presentation"><a href="#btnListGroupe" aria-controls="btnListGroupe" role="tab"
                                                       data-toggle="tab"><i class="fa fa-cubes fa-fw"></i> Groupe de
                                    liens</a></li>
                            <li role="presentation"><a href="#btnListForum" aria-controls="btnListForum" role="tab"
                                                       data-toggle="tab"><i class="fa fa-users fa-fw"></i> Forum</a>
                            </li>
                            <li role="presentation"><a href="#btnListChat" aria-controls="btnListChat" role="tab"
                                                       data-toggle="tab"><i class="fa fa-comments-o fa-fw"></i> Chat</a>
                            </li>
                            <li role="presentation"><a href="#btnListPodcast" aria-controls="btnListPodcast" role="tab"
                                                       data-toggle="tab"><i class="fa fa-comments-o fa-fw"></i> Podcast</a>
                            </li>
                            <li role="presentation"><a href="#btnListLibre" aria-controls="btnListLibre" role="tab"
                                                       data-toggle="tab"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> Libre</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div role="tabpanel" class="tab-pane fade in active" id="btnListLien">
                                <ul class="list-default courseElems">
                                    {% for key,val in liens %}
                                        {% include "cours/adminLien.html.twig"
                                            with {lien:val, zoneId: '0', inSection: 'false', lienTypes: typeLiens} %}
                                    {% endfor %}
                                </ul>
                            </div>
                            <div role="tabpanel" class="tab-pane fade" id="btnListDevoir">
                                <ul class="list-default courseElems">
                                    {% for key,val in devoirs %}
                                        {% include "cours/adminDevoir.html.twig"
                                            with {devoir:val.content, zoneId: '0', inSection: 'false', sujets: val.sujets, corrigesType: val.corrigesType} %}
                                    {% endfor %}
                                </ul>
                            </div>
                            <div role="tabpanel" class="tab-pane fade" id="btnListGroupe">
                                <ul class="list-default courseElems">
                                    {% for key,val in groupes %}
                                        {% include "cours/adminGroupe.html.twig"
                                            with {isVertical: val.groupe.isVertical, nom:val.groupe.nom, description: val.groupe.description,
                                            zoneId: '0', itemId: val.groupe.id, inSection: 'false', liens: val.content} %}
                                    {% endfor %}
                                </ul>
                            </div>
                            <div role="tabpanel" class="tab-pane fade in" id="btnListForum">
                                <ul class="list-default courseElems">
                                    {% for key,val in forums %}
                                        {% include "cours/adminForum.html.twig"
                                            with {forum:val, zoneId: '0', inSection: 'false'} %}
                                    {% endfor %}
                                </ul>
                            </div>
                            <div role="tabpanel" class="tab-pane fade in" id="btnListChat">
                                <ul class="list-default courseElems">
                                    {% for key,val in chats %}
                                        {% include "cours/adminChat.html.twig"
                                            with {chat:val, zoneId: '0', inSection: 'false'} %}
                                    {% endfor %}
                                </ul>
                            </div>
                            <div role="tabpanel" class="tab-pane fade" id="btnListPodcast">
                                <ul class="list-default courseElems">
                                    {% for key,val in podcasts %}
                                        {% include "cours/adminPodcast.html.twig"
                                            with {podcast:val, zoneId: '0', inSection: 'false'} %}
                                    {% endfor %}
                                </ul>
                            </div>
                            <div role="tabpanel" class="tab-pane fade" id="btnListLibre">
                                <ul class="list-default courseElems">
                                    {% for key,val in libres %}
                                        {% include "cours/adminLibre.html.twig"
                                            with {libre:val, zoneId: '0', inSection: 'false'} %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div role="tabpanel" class="tab-pane fade" id="sectionDocs">
                        <div class="course-list documentsDisc" data-activated="{{ cours.docsActivated }}"
                             style="margin-top: 0;">
                            <div class="course-media text-center mt-10">
                                <i class="fa fa-file-o fa-3" aria-hidden="true"></i>
                            </div>
                            <div class="course-detail">
                                <h4 class="heading headingSharedDocs">
                                    {% if cours.intituleSharedDocs != "" %}
                                        {{ cours.intituleSharedDocs }}
                                    {% else %}
                                        Mes documents partagés
                                    {% endif %}
                                </h4>
                                <div class="row">
                                    <label for="intituleSharedDocs" class=" col-xs-2">Intitulé</label>
                                    <input class=" col-xs-9" id="intituleSharedDocs" type="text"
                                           value="{{ cours.intituleSharedDocs }}"/>
                                    <a class="myBtn btnAlone btnAdmin col-xs-1 btnDesactivated btnValidateSharedDocsIntitule">
                                        <i class="fa fa-check" aria-hidden="true"></i>
                                    </a>
                                </div>
                                <div class="row">
                                    <label class="ml-10"> Activer le partage</label>
                                    <div class="myBtn btnAlone btnAdmin col-xs-1">
                                        {% if cours.docsActivated %}
                                            <i class="activationDocBtn fa fa-check-square-o"></i>
                                        {% else %}
                                            <i class="activationDocBtn fa fa-square-o"></i>
                                        {% endif %}
                                    </div>
                                </div>


                                <div class="resumeDocs mt-20 col-xs-12">
                                    <a href="{{ path('courseDocs', {id: cours.id}) }}" class="btn btn-primary btn-sm">Accéder</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--- administration des Zones des différentes sections (activation et tri)  -->
                    {% for key,val in zonesSections %}
                        <div role="tabpanel" class="section tab-pane fade"
                             id="t1body{{ val.section.id }}" data-idSection="{{ val.section.id }}">
                            <div class="editor">
                                <div class="row">
                                    <select id="ressCreaSelectPicker" class="selectpicker col-xs-6"
                                            data-style="MyBtnSelectPickeer"
                                            title="Ajouter une ressource">
                                        {% if isReferent or app.user.hasRole('ROLE_SUPER_ADMIN') %}
                                            <option title="Nouvelle ressource" class="addNewItem addNewTypeDevoir">
                                                Devoir
                                            </option>
                                            <option title="Nouvelle ressource" class="addNewItem addNewTypeLien">Lien
                                            </option>
                                            <option title="Nouvelle ressource" class="addNewItem addNewTypeGroupe">
                                                Groupe de liens
                                            </option>
                                            <option title="Nouvelle ressource" class="addNewItem addNewTypePodcast">
                                                Podcast
                                            </option>
                                            <option title="Nouvelle ressource" class="addNewItem addNewTypeLibre">Zone
                                                libre
                                            </option>
                                        {% endif %}
                                        <option title="Nouvelle ressource" class="addNewItem addNewTypeForum">Forum
                                        </option>
                                        <option title="Nouvelle ressource" class="addNewItem addNewTypeChat">Chat
                                        </option>
                                        {% if isReferent or app.user.hasRole('ROLE_SUPER_ADMIN') %}
                                            <option data-divider="true"></option>
                                            <option title="Nouvelle ressource" class="addExistingRessource">Ressource
                                                existante
                                            </option>
                                        {% endif %}
                                    </select>
                                </div>
                                <ul class="list-default courseElems">
                                    {% for keyR,valR in val.zones.content %}

                                        {% if val.zones.type[keyR] == "lien" %}
                                            <!--
                                                                LIENS
                                            -->
                                            {% include "cours/adminLien.html.twig"
                                                with {lien:valR, visible: val.zones.containers[keyR].isVisible, zoneId: val.zones.containers[keyR].id,
                                                inSection: 'true', lienTypes: typeLiens} %}
                                        {% elseif val.zones.type[keyR] == "groupe" %}
                                            <!--
                                                                GROUPES DE LIENS
                                            -->
                                            {% include "cours/adminGroupe.html.twig"
                                                with {isVertical: val.zones.groupe[keyR].isVertical, nom:val.zones.groupe[keyR].nom, description: val.zones.groupe[keyR].description,
                                                zoneId: val.zones.containers[keyR].id, itemId: val.zones.groupe[keyR].id, inSection: 'true',
                                                liens: valR, visible: val.zones.containers[keyR].isVisible} %}
                                        {% elseif val.zones.type[keyR] == "podcast" %}
                                            {% include "cours/adminPodcast.html.twig"
                                                with {podcast:val.zones.podcast[keyR], zoneId: val.zones.containers[keyR].id,
                                                inSection: 'true', visible: val.zones.containers[keyR].isVisible} %}
                                        {% elseif val.zones.type[keyR] == "devoir" %}
                                            <!--
                                                                DEVOIRS
                                            -->
                                            {% include "cours/adminDevoir.html.twig"
                                                with {devoir:valR, visible: val.zones.containers[keyR].isVisible,
                                                zoneId: val.zones.containers[keyR].id, inSection: 'true', sujets: val.zones.sujet[keyR], corrigesType: val.zones.corrigeType[keyR]} %}

                                        {% elseif val.zones.type[keyR] == "libre" %}
                                            <!--
                                                                LIBRE
                                            -->
                                            {% include "cours/adminLibre.html.twig"
                                                with {description: valR.description, visible: val.zones.containers[keyR].isVisible,
                                                zoneId: val.zones.containers[keyR].id, libre: valR, inSection: 'true'} %}
                                        {% elseif val.zones.type[keyR] == "forum" %}
                                            <!--
                                                                FORUM
                                            -->
                                            {% include "cours/adminForum.html.twig"
                                                with {forum:valR, description: valR.description, visible: val.zones.containers[keyR].isVisible,
                                                zoneId: val.zones.containers[keyR].id, itemId: valR.id, inSection: 'true'} %}
                                        {% elseif val.zones.type[keyR] == "chat" %}
                                            <!--
                                                                CHAT
                                            -->
                                            {% include "cours/adminChat.html.twig"
                                                with {chat:valR, description: valR.description, visible: val.zones.containers[keyR].isVisible,
                                                zoneId: val.zones.containers[keyR].id, itemId: valR.id, inSection: 'true', users: users} %}
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    {% endfor %}

                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>


                <!--                  ALERT SUPPRESSION DE RESSOURCE                     -->

                <div class="modal-body" data-contentModal="alertDeleteZoneRess" data-idItem=""
                     style="background:#aaa; background-size:cover">
                    <div class="row">
                        <div class="bginverse">
                            <div class="">
                                <div class="alert alert-danger mb-10">
                                    <strong>Attention!</strong> Vous allez supprimer une ressource qui est utilisée dans
                                    <span class="nbZoneUseOfRess"></span> sections !</p>
                                </div>
                                <div class="row mb-10" style="text-align: center">
                                    <div class="btn btn-sm btn-info mb-3 validateRessDeletion">Valider</div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!--                  UPLOAD DE FICHIER                     -->

                <div class="modal-body" data-contentModal="uploadFile" data-idItem=""
                     style="background:#aaa; background-size:cover">
                    <div class="row">
                        <div class="bginverse">


                        </div>
                    </div>
                </div>

                <!--                  EDITION DU LIEN D'UN GROUPE                      -->

                <div class="modal-body" data-contentModal="editLienInGroupe"
                     style="background:#aaa; background-size:cover">
                    <div class="row">
                        <div class="bginverse">
                            <table class="tableAddNewLienInGroup">
                                <tr>
                                    <td class="LabelAdmin">Nom du lien dans le groupe</td>
                                    <td><input data-champName="nomLienInGroupe" class="col-xs-8" value=""/></td>
                                </tr>
                                <tr>
                                    <td class="LabelAdmin">Catégorie du lien</td>
                                    <td>
                                        <select id="categorieEditLienInGroupeSelectPicker" class="selectpicker col-xs-8"
                                                data-style="MyBtnSelectPickeer" title="Categorie (couleur) du lien">
                                            {% for key,val in categorieLiens %}
                                                <option value="{{ val.id }}"
                                                        data-content="<span data-idCat='{{ val.id }}' class='couleurLabelOption' style='background-color:{{ val.couleur }};'>{{ val.nom }}</span>">{{ val.nom }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="LabelAdmin">Nom du lien</td>
                                    <td><input data-champName="groupeNewLien_nom" class="col-xs-8" value=""/></td>
                                </tr>
                                <tr>
                                    <td class="LabelAdmin">Url du lien</td>
                                    <td>
                                        <input data-champName="groupeNewLien_url" class="col-xs-8" value=""/>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="LabelAdmin">Type du lien</td>
                                    <td>
                                        <select id="typeEditLienInGroupeSelectPicker" class="selectpicker col-xs-8"
                                                data-style="MyBtnSelectPickeer" title="Type du lien (icone)">
                                            {% for key,val in typeLiens %}
                                                <option value="{{ val.id }}"
                                                        data-content="<span data-idType='{{ val.id }}' class='typeLabelOption'>{{ val.nom }} <i class='fa {{ val.faIcon }}'></i></span>">{{ val.nom }}</option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="LabelAdmin">Description du lien</td>
                                    <td><textarea id="editLienInGroupDescription"
                                                  data-champName="groupeNewLien_description"
                                                  class="simpleEditor editor champAdmin toActivate"></textarea></td>
                                </tr>
                            </table>
                            <div class="myBtn inlineBtn btnAdmin btnAlone btnSaveEditLienInGroupe">Enregistrer ce lien
                            </div>
                        </div>
                    </div>
                </div>


                <!--                  AJOUT D'UN LIEN DANS UN GROUPE                      -->

                <div class="modal-body" data-contentModal="ajoutLienToGroupe"
                     style="background:#aaa; background-size:cover">
                    <div class="row">
                        <div class="bginverse">
                            <div class="col-xs-12">
                                <div class="row mb-10">
                                    <div class="LabelAdmin col-xs-4">Nom du lien dans le groupe</div>
                                    <input data-champName="nomLienInGroupe" class="col-xs-8" value=""/>
                                </div>
                                <div class="row mb-10">
                                    <div class="LabelAdmin col-xs-4">Catégorie du lien</div>

                                    <select id="categorieLienInGroupeSelectPicker" class="selectpicker col-xs-8"
                                            data-style="MyBtnSelectPickeer" title="Categorie (couleur) du lien">
                                        {% for key,val in categorieLiens %}
                                            <option data-content="<span data-idCat='{{ val.id }}' class='couleurLabelOption' style='background-color:{{ val.couleur }};'>{{ val.nom }}</span>">{{ val.nom }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <hr/>
                            <ul class="nav nav-tabs" role="tablist">
                                <li role="presentation" class="active"><a href="#btnNewLienInGroupeModal"
                                                                          aria-controls="btnNewLienInGroupeModal"
                                                                          role="tab" data-toggle="tab"><i
                                                class="fa fa-external-link  fa-fw"></i> Nouveau Lien</a></li>
                                <li role="presentation"><a href="#btnOldLienInGroupeModal"
                                                           aria-controls="btnOldLienInGroupeModal" role="tab"
                                                           data-toggle="tab"><i class="fa fa-university fa-fw"></i> Lien
                                        existant</a></li>
                            </ul>
                            <div class="tab-content longLinkList">
                                <div role="tabpanel" class="tab-pane fade in active" id="btnNewLienInGroupeModal">
                                    <table class="tableAddNewLienInGroup">
                                        <tr>
                                            <td class="LabelAdmin">Nom du lien</td>
                                            <td><input data-champName="groupeNewLien_nom" class="col-xs-8" value=""/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="LabelAdmin">Url du lien</td>
                                            <td>
                                                <input data-champName="groupeNewLien_url" class="col-xs-8" value=""/>
                                                <div class="col-xs-8 infoLabel">Laissez vide pour uploader ensuite un
                                                    fichier
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="LabelAdmin">Type du lien</td>
                                            <td>
                                                <select id="typeLienInGroupeSelectPicker" class="selectpicker col-xs-8"
                                                        data-style="MyBtnSelectPickeer" title="Type du lien (icone)">
                                                    {% for key,val in typeLiens %}
                                                        <option data-content="<span data-idType='{{ val.id }}' class='typeLabelOption'>{{ val.nom }} <i class='fa {{ val.faIcon }}'></i></span>">{{ val.nom }}</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="LabelAdmin">Description du lien</td>
                                            <td><textarea id="newLienInGroupDescription"
                                                          data-champName="groupeNewLien_description"
                                                          class="simpleEditor editor champAdmin toActivate"></textarea>
                                            </td>
                                        </tr>
                                    </table>
                                    <div class="myBtn inlineBtn btnAdmin btnAlone btnAddNewLienToGroupe">Ajouter ce
                                        nouveau lien
                                    </div>
                                </div>
                                <div role="tabpanel" class="tab-pane fade" id="btnOldLienInGroupeModal">
                                    <table class="tableAddItem">
                                        {% for key,val in liens %}
                                            <tr class="item" data-typeItem="lien" data-idItem="{{ val.id }}">
                                                <td>
                                                    <table class="tableDetailItem">
                                                        <tr>
                                                            <td class="nomChamp">Nom</td>
                                                            <td>{{ val.nom }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Url</td>
                                                            <td>{{ val.url }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Description</td>
                                                            <td>{{ val.description | raw }}</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td>
                                                    <div class="myBtn btnAdmin btnAlone btnAddLienToGroupe"><i
                                                                class="fa fa-plus"></i></div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!--                  AJOUT D'UN MP3 dans un Podcast                     -->

                <div class="modal-body" data-contentModal="ajoutMp3ToPodcast"
                     style="background:#aaa; background-size:cover">
                    <div class="row">
                        <div class="bginverse">
                            <div class="tab-content longLinkList">
                                <div role="tabpanel" class="tab-pane fade in active">
                                    <table class="tableAddNewLienInGroup">
                                        <tr>
                                            <td class="LabelAdmin">Nom du Mp3</td>
                                            <td><input data-champName="podcastNewMp3_nom" class="col-xs-8" value=""/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="LabelAdmin">Fichier à déposer</td>
                                            <td class="uploadMp3Zone">
                                                <input class="col-xs-8" data-champName="podcastNewMp3_url" readonly />
                                                <div class="fileUploader btn">
                                                    <span class="btn btn-success fileinput-button">
                                                        <i class="glyphicon glyphicon-plus"></i>
                                                        <span>Ajouter un fichier</span>
                                                        <input id="mp3Upload" type="file" name="files[]" multiple/>
                                                    </span>
                                                    <div id="itemProgress" class="progress col-xs-12">
                                                        <div class="progress-bar progress-bar-success"></div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="LabelAdmin">Description du mp3</td>
                                            <td><textarea id="newMp3InPodcastDescription"
                                                          data-champName="podcastNewMp3_description"
                                                          class="simpleEditor editor champAdmin toActivate"></textarea>
                                            </td>
                                        </tr>
                                    </table>
                                    <div class="myBtn inlineBtn btnAdmin btnAlone btnAddNewMp3ToPodcast">Ajouter ce
                                        nouveau mp3
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!--                  AJOUT D'UNERESSOURCE DANS UNE SECTION                      -->

                <div class="modal-body" data-contentModal="ajoutRessExist" data-idSection="0"
                     style="background:#aaa; background-size:cover">
                    <div class="row">
                        <div class="bginverse">
                            <ul class="nav nav-tabs" role="tablist">
                                <li role="presentation" class="active"><a href="#btnListLienModal"
                                                                          aria-controls="btnListLienModal" role="tab"
                                                                          data-toggle="tab"><i
                                                class="fa fa-external-link  fa-fw"></i> Lien</a></li>
                                <li role="presentation"><a href="#btnListDevoirModal" aria-controls="btnListDevoirModal"
                                                           role="tab" data-toggle="tab"><i
                                                class="fa fa-university fa-fw"></i> Devoir</a></li>
                                <li role="presentation"><a href="#btnListGroupeModal" aria-controls="btnListGroupeModal"
                                                           role="tab" data-toggle="tab"><i
                                                class="fa fa-cubes fa-fw"></i> Groupe de liens</a></li>
                                <li role="presentation"><a href="#btnListForumModal" aria-controls="btnListForumModal"
                                                           role="tab" data-toggle="tab"><i
                                                class="fa fa-users fa-fw"></i> Forum</a></li>
                                <li role="presentation"><a href="#btnListChatModal" aria-controls="btnListChatModal"
                                                           role="tab" data-toggle="tab"><i
                                                class="fa fa-comments-o fa-fw"></i> Chat</a></li>
                                <li role="presentation"><a href="#btnListPodcastModal"
                                                           aria-controls="btnListPodcastModal"
                                                           role="tab" data-toggle="tab"><i
                                                class="fa fa-comments-o fa-fw"></i> Podcast</a></li>
                                <li role="presentation"><a href="#btnListLibreModal"
                                                           aria-controls="btnListLibreModal"
                                                           role="tab" data-toggle="tab"><i
                                                class="fa fa-pencil-square-o" aria-hidden="true"></i> Libre</a></li>
                            </ul>
                            <div class="tab-content">
                                <div role="tabpanel" class="tab-pane fade in active" id="btnListLienModal">
                                    <table class="tableAddItem">
                                        {% for key,val in liens %}
                                            <tr class="item" data-typeItem="lien" data-idItem="{{ val.id }}">
                                                <td>
                                                    <table class="tableDetailItem">
                                                        <tr>
                                                            <td class="nomChamp">Nom</td>
                                                            <td>{{ val.nom }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Url</td>
                                                            <td>{{ val.url }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Description</td>
                                                            <td>{{ val.description | raw }}</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td>
                                                    <div class="myBtn btnAdmin btnAlone btnAddItem"><i
                                                                class="fa fa-plus"></i></div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                                <div role="tabpanel" class="tab-pane fade" id="btnListDevoirModal">
                                    <table class="tableAddItem">
                                        {% for key,val in devoirs %}
                                            <tr class="item" data-typeItem="devoir" data-idItem="{{ val.content.id }}">
                                                <td>
                                                    <table class="tableDetailItem">
                                                        <tr>
                                                            <td class="nomChamp">Nom</td>
                                                            <td>{{ val.content.nom }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Description</td>
                                                            <td>{{ val.content.description | raw }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Dates</td>
                                                            <td>du {{ val.content.dateDebut|date('Y-m-d') }}
                                                                au {{ val.content.dateFin|date('Y-m-d') }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Durée</td>
                                                            <td>{{ val.content.duree//3600 }}h</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Barême</td>
                                                            <td>{{ val.content.bareme }} points</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Commentaire Copie Rendue</td>
                                                            <td>{{ val.content.commentaireCopieRendue | raw }}</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td>
                                                    <div class="myBtn btnAdmin btnAlone btnAddItem"><i
                                                                class="fa fa-plus"></i></div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                                <div role="tabpanel" class="tab-pane fade" id="btnListGroupeModal">
                                    <table class="tableAddItem">
                                        {% for key,val in groupes %}
                                            <tr class="item" data-typeItem="groupe" data-idItem="{{ val.groupe.id }}">
                                                <td>
                                                    <table class="tableDetailItem">
                                                        <tr>
                                                            <td class="nomChamp">Nom</td>
                                                            <td>{{ val.groupe.nom }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Description</td>
                                                            <td>{{ val.groupe.description | raw }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Liens présents</td>
                                                            <td>
                                                                <ul>
                                                                    {% for keyR,valR in val.content %}
                                                                        <li>{{ valR.nom }}</li>
                                                                    {% endfor %}
                                                                </ul>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td>
                                                    <div class="myBtn btnAdmin btnAlone btnAddItem"><i
                                                                class="fa fa-plus"></i></div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                                <div role="tabpanel" class="tab-pane fade" id="btnListPodcastModal">
                                    <table class="tableAddItem">
                                        {% for key,val in podcasts %}
                                            <tr class="item" data-typeItem="podcast" data-idItem="{{ val.id }}">
                                                <td>
                                                    <table class="tableDetailItem">
                                                        <tr>
                                                            <td class="nomChamp">Nom</td>
                                                            <td>{{ val.nom }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Description</td>
                                                            <td>{{ val.description | raw }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Mp3s présents</td>
                                                            <td>
                                                                <ul>
                                                                    {% for keyR,valR in val.mp3s %}
                                                                        <li>{{ valR.nom }}</li>
                                                                    {% endfor %}
                                                                </ul>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td>
                                                    <div class="myBtn btnAdmin btnAlone btnAddItem"><i
                                                                class="fa fa-plus"></i></div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                                <div role="tabpanel" class="tab-pane fade" id="btnListLibreModal">
                                    <table class="tableAddItem">
                                        {% for key,val in libres %}
                                            <tr class="item" data-typeItem="libre" data-idItem="{{ val.id }}">
                                                <td>
                                                    <table class="tableDetailItem">
                                                        <tr>
                                                            <td class="nomChamp">Nom</td>
                                                            <td>{{ val.nom }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Description</td>
                                                            <td>{{ val.description | raw }}</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td>
                                                    <div class="myBtn btnAdmin btnAlone btnAddItem"><i
                                                                class="fa fa-plus"></i></div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                                <div role="tabpanel" class="tab-pane fade in" id="btnListForumModal">
                                    <table class="tableAddItem">
                                        {% for key,val in forums %}
                                            <tr class="item" data-typeItem="forum" data-idItem="{{ val.id }}">
                                                <td>
                                                    <table class="tableDetailItem">
                                                        <tr>
                                                            <td class="nomChamp">Nom</td>
                                                            <td>{{ val.nom }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Description</td>
                                                            <td>{{ val.description | raw }}</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td>
                                                    <div class="myBtn btnAdmin btnAlone btnAddItem"><i
                                                                class="fa fa-plus"></i></div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                                <div role="tabpanel" class="tab-pane fade in" id="btnListChatModal">
                                    <table class="tableAddItem">
                                        {% for key,val in chats %}
                                            <tr class="item" data-typeItem="chat" data-idItem="{{ val.id }}">
                                                <td>
                                                    <table class="tableDetailItem">
                                                        <tr>
                                                            <td class="nomChamp">Nom</td>
                                                            <td>{{ val.nom }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="nomChamp">Description</td>
                                                            <td>{{ val.description | raw }}</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td>
                                                    <div class="myBtn btnAdmin btnAlone btnAddItem"><i
                                                                class="fa fa-plus"></i></div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}